# Работа с Ик датчиками на Raspberry pi 3
---
## Подключение ИК приемника
---

Большинство ИК приемников работают и подключаются одинаково. У таких приемников есть 3 пина для подключения, G/GND - земля, V/VCC - питание 5В, S/OUT - сигнал. 
<img src="../assets/IR_reciver_connection.png" height="400px" alt="ir reciver connection to raspberry">

> **Hint** Сигнальный порт не обязательно должен подключаться к порту GPIO 17, данный пин можно изменить во время [настройки портов in/out](#abcd)

---
## Настройка ИК приемника и работа с модулем LIRC
LIRC – Linux Infrared Remote Control
LIRC стабильная и проверенная библиотека с открытым кодом, которая позволяет отправлять и получать команды по инфракрасному порту. LIRC поддерживается Raspbian.
Для установки модуля LIRC нужно подключить вашу Raspberry pi к интернету и выполнить консольные команды:
```bash
$ sudo apt-get update
$ sudo apt-get install lirc
```

> **Hint** Для корректного редактирования системных файлов требуется иметь права администратора, для этого используйте `sudo` при вызове редактора текста.

<a name="abcd"></a>
После установки модуля нужно будет редактировать файл `/etc/modules` и добавить в него строки:
```
lirc_dev
lirc_rpi gpio_in_pin=18 gpio_out_pin=17
```

> **Hint** Значения GPIO пинов in/out могут задаваться в соответсвии с желанием пользователя.

Где:
+ gpio_in_pin – Pin входа от приемника
+ gpio_out_pin – Pin выхода для передатчика

Обновляем следующую строку в файле `/boot/config.txt`.

```
dtoverlay=lirc-rpi,gpio_in_pin=18,gpio_out_pin=17
```
 
Добаваляем следующие строки в файл `/etc/lirc/hardware.conf`. При отсутствии данного файла создаем его вручную.

```
LIRCD_ARGS="--uinput --listen"
LOAD_MODULES=true
DRIVER="default"
DEVICE="/dev/lirc0"
MODULES="lirc_rpi"
```

Обновляем следующие строки в файле `/etc/lirc/lirc_options.conf`

```
driver    = default
device    = /dev/lirc0
```

Все требуемые настройки сделаны, теперь нужно перезагрузить соответствующий демон. Сделать это можно двумя способами, напрямую через `init.d` или через аругмент `service`. Для этого выполните соответствующие команды.

```
$ sudo /etc/init.d/lircd stop
$ sudo /etc/init.d/lircd start
```

Или 

```
$ sudo service lircd resart
```

После перезагрузки проверьте его статус, вызвав команду:

```
$ sudo /etc/init.d/lircd status
```

Если вы все сделали правильно, то статус работы должен быть `active`.
Перед проведением тестирования лучше будет перезагрузить вашу Raspberry pi, командой `sudo reboot`.

Что бы проверить, что установленный модуль lirc работает выключите демон lircd и вызовите соответствующую команду:

```
$ sudo /etc/init.d/lircd stop
$ mode2 -d /dev/lirc0
```

Теперь направив ИК передатчик на ваше устройство и нажав несколько кнопок вы должны увидеть что-то похожее на это:

```
space 402351
pulse 135
space 7085
pulse 85
space 2903
pulse 560
space 1706
pulse 535
```

> **Hint** В ситуации, если вы используете ИК передатчик(TV пуль, пульт от кондиционеров, и т.д.) и во время проверки вы не получаете сигнал, возможно ваш пульт использует другую частоту передачи сигнала. При использовании приемников типа TSOP 22XX рабочая частота приема сигнала будет в диапазоне от 30 до 50 kHZ.

## Запись своей конфигурации ИК пульта

В случае если вы хотите использовать свой ИК передатчик, вам нужно записать его характерные настройки с помощью прилагающегося модуля `irrecord`. Для этого вам нужно выключить демон `lircd` и вызвать соответствующую команду. Во время клабирбровки пульта точно выполняйте все написанные интсрукции.

> **Hint** Обратите внимание, что на последнем шаге калибровки, вам нужно будет задать наименования кнопок, которые вы захотите расшифровать программно. Для того, что бы посмотреть список доступных имен, вызовите команду `irrecord --list-namespace`.

```bash
$ irrecord -d /dev/lirc0 ~/lircd.conf
```

Если у вас успешно получилось записать конфигурацию вашего пульта, в папке `~/pi/` должен был появиться файл `_введенное-имя_.lircd.conf`. Теперь вам нужно перенести записанный конфигурационный файл в рабочую папку `lirc` и перезагрузить демон.

```bash
$ sudo cp ~/lircd.conf /etc/lirc/lircd.conf
$ sudo /etc/init.d/lirc restart
```

Для того, что бы проверить, распознается ли записаная вами конфигурация, вывзовите соответствующий модуль. Теперь при нажатии на кнопки, которые вы записали в ранее созданной конфигурации, в терминал будет выводиться информация о том, какая кнопка нажата и как вы ее назвали при записи. 

```bash
$ irw
```

В случае, если при нажатии на требуемые клавиши вы получаете вывод похожий на:

```
000000007689718e 01 KEY_OK
```

Это значит, что ваша конфигурация корректно распознается программой и теперь вы можете запрограммировать нужные вам действия в случае нажатия требуемой клавиши.
