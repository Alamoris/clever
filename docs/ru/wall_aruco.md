# Навигация по вертикальным ArUco-маркерам

Алгоритм обработки визуальных ArUco-маркеров, реализованный в образе Клевера позволяет максимально гибко настраивать положение как камеры, так и положение самих маркеров.

## Установка вертикального крепления камеры

Для более точного распознавания маркеров необходимо установить камеру вертикально, таким образом, чтобы объектив был направлен параллельно горизонту.

> **Note** Конфигурационный файл позволяет настраивать расположение камеры в пространстве относительно коптера любым образом. Для удобства далее будет рассматриваться вариант установки камеры под 90° к горизонту, по направлению носа коптера.

### Крепление камеры, 3D печать

Распечатайте [крепление камеры]() на 3D принтере.

По длине имеющегося у вас шлейфа установите крепление в удобное место, таким образом, чтобы в камере было минимальное количество лишних объектов(защита, ножки, пропеллеры, лучи), все эти части будут негативно сказываться на распознавании маркеров.

TODO: Добавить stl модели

## Настройка расположения камеры

Чтобы установить расположение камеры под необходимым вам углом, откройте файл *main_camera.launch*, расположенному по пути */home/pi/catkin_ws/src/clever/clever/launch/main_camera.launch*.

```bash
nano /home/pi/catkin_ws/src/clever/clever/launch/main_camera.launch
```

Необходимо или отредактировать одну из конфигурационных строк или добавить строку представленную ниже:

```
<node pkg="tf2_ros" type="static_transform_publisher" name="main_camera_frame" args="0.05 0 0.05 -1.5707963 0 -1.5707963 base_link main_camera_optical"/>
```

> **Note** Единовременно может использоваться только одна строка конфигурации камеры, если вы вставляете представленную выше строку, не забудьте закомментировать активную на данный момент. Для определения этого, вам поможет подсветка синтаксиса, используемая строка будет подсвечена другим цветом, нежели комментарии. Для комментирования в начало и конец строки добавьте символы *<!-- и -->* соответственно.

Если используемая вами карта маркеров имеет равномерные расстояния между ними, можете воспользоваться [утилитой для создания карт *gen_map.py*](#настройка-карты-маркеров). В случае если ваши маркеры расположены в случайном порядке вам потребуется задать ее вручную, для этого перейдите в директорию */home/pi/catkin_ws/src/clever/aruco_map/map* и создайте файл карты *map_name.txt*. Заполните вашу карту в соответствии с [синтаксисом карты](#настройка-карты-маркеров). Пример карты маркеров со случайным расположением маркеров:

> **Hint** При задаче карты выберите один из маркеров, как начало координат и относительно него отмеряйте расстояние до всех остальных маркеров. Вы можете не указывать все 8 параметром, в случае если все ваши маркеры ориентированны одинаково, можно указывать только первые 5 параметров: индекса маркера, размера маркера и его расположения в пространстве по трем осям, соответственно.

```
106 0.33    0   0   0
103 0.33    1.53    0.23    0
153 0.40    -0.56   1.36    0
```

После того, как карта введена, необходимо применить ее, для этого отредактируйте файл *aruco.launch*, расположенный по пути */home/pi/catkin_ws/src/clever/clever/launch/aruco.launch*. Измените в нем строку `<param name="map" value="$(find aruco_pose)/map/map_name.txt"/>`, указав наименование вашего файла с картой.

При использовании маркеров не привязанных к горизонтальным плоскостям(пол, потолок), необходимо отключить параметр `known_tilt`, как в модуле `aruco_detect`, так и в модуле `aruco_map`.

После всех настроек вызовите `sudo systemctl restart clever`, для перезагрузки сервиса *clover*.

## Проверка настройки

Для того, чтобы проверить правильность положения камеры, воспользуйтесь web утилитой *View 3D visualization*. Если направление камеры указано верно, вы увидите такую картину:

<div class="image-group">
    <img src="../assets/" width=300 class="zoom border">
    <img src="../assets/" width=300 class="zoom border">
</div>

Правильность введенной карты проверьте с помощью визуализации *aruco_image/debug*, выведенное изображение должно соответствовать вашей карте. Далее, проверьте, что на полученном изображении *aruco_map/debug*, начало системы координат статично и находится в выбранной вами точке.

TODO: Добавить скрины