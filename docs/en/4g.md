# Multi-copter control with 4G communication

The fourth generation mobile communication is a convenient tool for transmitting and receiving information at high speed. Nowadays, the coverage area of mobile operators allows to connect to the Internet at high speed from almost any point.

> **Hint** To transfer any data from your copter to the ground station (QGroundControl) and back, you need to set up your own VPN network.

## Connecting Raspberry Pi to the VPN

Connect a 4G modem with SIM card to the USB port of your Raspberry Pi.

> **Hint** It is suggested to use UDP transfer protocol to control the copter, which provides less delay, at the cost of no guarantee of receiving the package, which is very important during the copter pilot.

Form the VPN network keys to connect Raspberry Pi and the ground station.

To connect Raspberry Pi to your network, install the *openvpn* package:

```bash
sudo apt-get install openvpn
```

Move your keys to the */etc/openvpn/client* directory. For convenience, use the graphical SFTP data transfer interface, for example: WinSCP, FileZilla, etc.

To enable the client mode, you must activate the keys you have transmitted. Keys can be generated in various formats, for example: *.ovpn*, *.conf*. The key or configuration used on your copter should be strictly in *.conf* format.

Initialize the service that uses your keys to connect in client mode:

```bash
sudo systemctl enable openvpn-client@config-name
```

where *config-name* is the name of your configuration file.

If everything is done correctly, every time the system restarts, the service client will automatically connect to your network.

> **Hint** Before starting work, do not forget to set up and enable VPN connection on your PC.

## Copter control via QGroundControl

Make sure your copter and ground station are connected to your network.

To do this, you can use the command `ip addr`. The result will be a numbered list of the active networks enabled on your device. Note the connection with the prefix *tun* and the IP address you specify, if it is present in your list, your copter is connected to the network.

In QGroundControl, like [Wi-Fi connection](gcs_bridge.md), set up a connection to your copter using the protocol used on your network: *UDP/TCP*. It is recommended to use *UDP* connection, due to higher data transfer rate.

If you have a connection to your copter, connect some joystick to your PC. The role of the joystick can be played by radio consoles, such as FlySky-i6X, Taranis x7, etc., as well as by set-top boxes or any emulation thereof that is recognized by the system.

When the joystick is recognized by the system, the *Joystick* item will appear in the *Vehicle Setup* column, if it is highlighted in red, it means that calibration is required.

To calibrate the joystick, press the *Calibrate* button in the *Joystick* tab and follow the instructions for the sticks position on the left side of the window.

<div class="image-group">
    <img src="../assets/4g/calibrate.png" width=300 class="zoom border">
    <img src="../assets/4g/calibration_instruction.png" width=300 class="zoom border">
</div>

After successful calibration, flight modes must be set up. To do this, switch the required toggle switches several times. During switching, you will see the virtual channels on which the toggle switches operate. One of the channels will be highlighted in the active position.

<img src="../assets/4g/fly_modes.png" width=300 class="zoom center border">

> **Info** When selecting the joystick, check the number of working channels and its support in QGroundControl(SDL2). There are joysticks that support only 4 channels, which is not convenient for this type of control.

If changes to stick positions are shown in the QGroundControl window, all you have to do is apply a parameter that specifies that the copter is controlled by the joystick, not by the radio:

`COM_RC_IN_MODE` - Joystick/No RC Checks

Since mobile communication is not always stable, it is recommended to increase the timeout for loss of control signal to 5 seconds.

<img src="../assets/4g/failsafe.png" width=300 class="zoom center border">

Copter ready to fly!

> **Hint** If the copter does not arm itself when moving the left stick to the bottom right corner, set the Arm/Disarm status to one of the tumblers.

## Transferring video from the camera to QGroundControl

You can transfer video from almost any camera connected to your Raspberry Pi. You will need to install or [build] (https://github.com/sfalexrog/gst-rtsp-launch) the *gst-rtsp-launch* package:

```bash
sudo apt-get install gst-rtsp-launch
```

To start the transfer of images, you must enter the appropriate command line:

<a id="command_line"></a>

```bash
gst-rtsp-launch "( v4l2src device=/dev/video0 ! video/x-raw,framerate=30/1,width=320,height=240 ! v4l2h264enc output-io-mode=4 extra-controls=\"encode,frame_level_rate_control_enable=1,h264_profile=4,h264_level=13,video_bitrate=300000,h264_i_frame_period=5;\" ! rtph264pay name=pay0 pt=96 )"
```

This command line contains the parameters of transmission of video, such as: device of transmission, frequency of shots, height/width of image, method of encoding etc. More detailed about tuning [it is possible to know here](https://github.com/sfalexrog/gst-rtsp-launch/blob/master/README.md).

In the appendix of QGroundControl check, that began стрим images.

<img src="../assets/4g/video_stream.png" width=300 class="zoom center border">

## Automation of start of transmission of video

Create a file and add to it [command line]:

```bash
nano script_name.sh
```

That it is correct to start a file, it is necessary to appropriate the corresponding flags of access to him.

```bash
chmod a+x script_name.sh
```

In order that the transmission of video was started each time at including of the system, it is necessary to create a startup-script by means of manager of systemd. In the directory */etc/systemd/system* create the file *qgc_video.service*.

```bash
sudo nano /etc/systemd/system/qgc_video.service
```

In a file write down corresponding lines:

```
[Unit]
Description=VideoStream

[Service]
ExecStart=/bin/bash /home/pi/script_name.sh

[Install]
WantedBy=multi-user.target
```

Remained only to initialize your script in the system.

```bash
sudo systemctl enable qgc_video.service
```
